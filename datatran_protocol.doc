数据传输系统规约

1 系统功能
系统实现自组网，自维护，数据传输。数据能够实现中继，透传，最大透传数据128Byte，实现P2P（点对点透传）。
2 数据帧结构
2.1字节模式
帧的基本单元为8位字节。链路层传输顺序为低位在前，高位在后；低字节在前，高字节在后。
字节传输按异步方式进行，通信速率9600bps或以上，默认为9600bps，它包含8个数据位、1个起始位“0”、1个偶校验位P和1个停止位“1”，定义见图1。

0	D0	D1	D2	D3	D4	D5	D6	D7	P	1
起始位	8个数据位	偶校验位	停止位
图1　传输字节格式
2.2 帧格式
2.2.1 帧格式定义
本部分采用异步式传输帧格式，定义见图2。

起始字符（A4H）		报文头
地址域（A0-A6）		
起始字符（A4H）		
控制域C		控制域
数据标识Fn		数据标识
用户数据长度L		数据长度L


用户数据

		用户数据区
		
		
		
结束字符（16H）		结束字符（16H）
图2　传输帧格式
2.2.2 传输规则
a)线路空闲状态为二进制1。 
b)帧的字符之间无线路空闲间隔。
c)如按d）检出了差错，两帧之间的线路空闲间隔最少需33位。
d)接收方校验：
1)对于每个字符：校验起动位、停止位、偶校验位。
2)对于每帧：
(1)检验帧的固定报文头中的起始字符；
(2)识别1个长度L；
(3)每帧接收的字符数为用户数据长度L1+12；
(4)结束字符；
(5)校验出一个差错时，校验按c）的线路空闲间隔。
若这些校验有一个失败，舍弃此帧；若无差错，则此帧数据有效。
2.2.3 数据帧长度L
长度L是指帧数据的总长度，由1字节组成，BIN格式，包括用户数据长度L1和12个字节的固定长度（报文头、控制域、数据标识，数据长度，结束字符），长度L不大于256。
2.3 地址域
地址域目的地址A组成，格式见表6。
表1　地址域格式
地址域	数据格式	字节数
目的地址A	BIN	6

2.4 控制域
控制域为功能码，根据不同的功能码实现不同的功能。
应用层功能码AFN由一字节组成，采用二进制编码表示，具体定义见表7。
表2　应用层功能码定义
应用功能码AFN	应用功能定义	具体项目
00H	确认∕否认	F1：确认
		F2：否认
01H	数据转发	F1：转发数据
02H	查询数据	F1：版本信息
		F2：节点参数信息
03H	信道跳转	F1：信道跳转
04H	引脚控制	F1：引脚控制
05H	参数设置	F1：信道设置
		F2：功率设置
		F3：节点类型设置

2.5 数据标识定义
数据单元标识由1个字节组成，表示信息类型，格式见图6。

信息类	D7	D6	D5	D4	D3	D2	D1	D0

F1->0x01
F2->0x02
Fn->n 
Fn 最大为255，最小为0。

3 报文结构
3.1 确认/否认(AFN=00H)
3.1.1 报文格式
确认∕否认命令上行报文格式见3。

A4H
A(A0-A6)
A4H
AFN=00H
Fn
L（数据长度）
数据单元
16H
图3　确认/否认命令上行报文格式
3.1.2 Fn定义
Fn定义见3。
表3　确认/否认Fn定义
Fn	名称及说明
F1	确认
F2	否认
F3～F255	备用


3.1.3 Fn数据单元格式
3.1.3.1 F1数据单元
无数据单元。
数据帧示例：
A4 A0-A6 A4 00 01 00 16

3.1.3.2 F2数据单元
    数据单元格式见表10。
表4　否认数据单元格式
数据内容	数据格式	字节数
错误状态字	BIN	1

   错误状态字：0为通信超时,其他备用。
   数据帧示例：A4 A0-A6 A4 00 01 01 00 16 地址A为节点地址。




3.2 数据转发 (AFN=01H)
3.2.1 下行报文格式
确认∕否认命令上行报文格式见4。

A4H
A(A0-A6)
A4H
AFN=01H
Fn
L（数据长度）
数据单元
16H
图4　确认/否认命令上行报文格式
3.2.2 Fn定义
Fn定义见3。
表5　确认/否认Fn定义
Fn	名称及说明
F1	数据转发
F2～F255	备用
 

3.2.3 Fn数据单元格式
3.2.3.1 F1数据单元
数据单元
数据内容	数据格式	字节数
数据帧	BIN	L1
备注：数据长度不超过128字节。
数据帧示例：
A4 A0-A6 A4 01 01 L1 转发数据 16
示例:数据长度为3
A4 A0-A6 A4 01 01 0x03 D0 D1 D2 16


3.2.4 上行报文格式
   确认否认帧。
   节点应答确认帧，如果超时，由中心节点应答否认帧。

3.3 查询数据 (AFN=02H)
3.3.1 下行报文格式
确认∕否认命令上行报文格式见4。

A4H
A(A0-A6)
A4H
AFN=02H
Fn
L（数据长度）
数据单元
16H
图5　确认/否认命令上行报文格式
3.3.2 Fn定义
Fn定义见3。
表6　确认/否认Fn定义
Fn	名称及说明
F1	查询版本
F2	查询配置
F3～F255	备用


3.3.3 Fn数据单元格式
3.3.3.1 F1数据单元
无数据单元


3.3.3.2 F2数据单元
    无数据单元。

3.3.4 上行报文格式
3.3.4.1 F1数据单元
    
数据内容	数据格式	字节数
软件版本	BIN	2
例如软件版本为2.1数据表示为0x02 0x01
3.3.4.2 F2数据单元
 
数据内容	数据格式	字节数
信道	BIN	1
功率	BIN	1
节点地址	BIN	6
  
注意事项：如果超时中心节点应答否认帧，未超时，则由相应节点应答数据。


3.4 信道跳转 (AFN=03H)
中心节点命令，由中心节点处理，子节点不处理。
3.3.1 下行报文格式
确认∕否认命令上行报文格式见4。

A4H
A(A0-A6)
A4H
AFN=03H
Fn
L（数据长度）
数据单元
16H
图6　确认/否认命令上行报文格式
3.3.2 Fn定义
Fn定义见3。
表7　确认/否认Fn定义
Fn	名称及说明
F1	信道跳转
F2～F255	备用


3.3.3 Fn数据单元格式
3.3.3.1 F1数据单元
数据内容	数据格式	字节数
信道标号	BIN	1


3.3.4 上行报文格式  
注意事项：中心节点应答确认否认帧。




3.5 引脚控制 (AFN=04H)
3.5.1 下行报文格式
确认∕否认命令上行报文格式见4。

A4H
A(A0-A6)
A4H
AFN=04H
Fn
L（数据长度）
数据单元
16H
图7　确认/否认命令上行报文格式
3.5.2 Fn定义
Fn定义见3。
表8　确认/否认Fn定义
Fn	名称及说明
F1	查询版本
F2～F255	备用


3.5.3 Fn数据单元格式
3.5.3.1 F1数据单元
数据内容	数据格式	字节数
引脚编号	BIN	1
引脚输出电平	BIN	1

3.5.4 上行报文格式
确认帧。  
注意事项：如果超时中心节点应答否认帧。


3.6 查询数据 (AFN=05H)
3.6.1 下行报文格式
确认∕否认命令上行报文格式见4。

A4H
A(A0-A6)
A4H
AFN=05H
Fn
L（数据长度）
数据单元
16H
图8　确认/否认命令上行报文格式
3.6.2 Fn定义
Fn定义见3。
表9　确认/否认Fn定义
Fn	名称及说明
F1	信道设置
F2	功率设置
F3	节点类型设置
F4～F255	备用


3.6.3 Fn数据单元格式
3.6.3.1 F1数据单元
数据内容	数据格式	字节数
信道标号	BIN	1

3.6.3.2 F2数据单元
    
数据内容	数据格式	字节数
功率数值	BIN	1

3.6.3.3 F3数据单元
数据内容	数据格式	字节数
节点类型	BIN	1

3.6.4 上行报文格式
确认帧。  
注意事项：如果超时中心节点应答否认帧，未超时，则由相应节点应答数据。






附录
1 信道标号
在本版本中信道标号为1-32，其他备用。
2 功率值
在本版本中功率
20dbm ->  255
17dbm ->  
